<!DOCTYPE html>
<meta charset="utf-8">
<style>
 
body {
    background: #222;
    font-family: sans-serif;
    font-style: italic;
}
 
</style>
<body>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script>

var CLICK_DISTANCE = 4,
    CLICK_DISTANCE_2 = CLICK_DISTANCE * CLICK_DISTANCE;

var curling = d3.select('body');
var width = 500,
    height = 1000,
    sixfeet = width / 2 *0.9,
    rockwidth = sixfeet / 6 * 10 / 12,
    rockradius = rockwidth/2,
    rockoutline = rockwidth/5,
    spacer = rockwidth/4,
    svg_rockradius = rockradius + rockoutline/2;

var radii = {
    "twelve": sixfeet,
    "eight": sixfeet*2/3,
    "four": sixfeet/3,
    "button": sixfeet/12,
};

var pin = {
    "x": width/2
    ,"y": radii.twelve + sixfeet
}

var rocks = []
var row = 0, col = 1;
for (let i = 1; i <= 8; ++i) {
    col = i % 2 + 1;
    if (i%2) row++;
    let x = rockwidth * col + spacer * (i%2) + 1
    let y = rockwidth * row + spacer * (row-1)
    rocks.push({x: x, y: y, name: `red${i}`, color: "red", id: i})

    x = width - rockwidth * col - spacer * (i%2) + 1
    y = rockwidth * row + spacer * (row-1)
    rocks.push({x: x, y: y, name: `yel${i}`, color: "yellow", id: i+8})       
}

var measures = []

var house = []
cx = width/2
cy = radii.twelve + sixfeet
for (r in radii) {
    house.push({r: r, cx: cx, cy: cy, })
}
 

var svg = curling.append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .attr("class", "house")

//sheet
svg.append("rect")
    .attr("class", "sheet")
    .attr("width", width)
    .attr("height", height)
    .attr("x", 0)
    .attr("y", 0)
    .style("fill", "white")

var backline = 2
svg.append("line")
    .name()
    .attr("x1", 0)
    .attr("y1", sixfeet)
    .attr("x2", width)
    .attr("y2", sixfeet)
    .style("stroke", "black")
    .style("stroke-width", backline)

svg.append("circle")
    .attr("name", "twelve")
    .attr("class", "house")
    .attr("r", radii.twelve)
    .attr("cx", pin.x)
    .attr("cy", pin.y)
    .style("fill", "blue")
    .style("stroke", "black")

svg.append("circle")
    .attr("name", "eight")
    .attr("class", "house")
    .attr("r", radii.eight)
    .attr("cx", pin.x)
    .attr("cy", pin.y)
    .style("fill", "white")
    .style("stroke", "black")

svg.append("circle")
    .attr("name", "four")
    .attr("class", "house")
    .attr("r", radii.four)
    .attr("cx", pin.x)
    .attr("cy", pin.y)
    .style("fill", "red")
    .style("stroke", "black")

svg.append("line")


svg.append("circle")
    .attr("name", "button")
    .attr("class", "house")
    .attr("r", radii.button)
    .attr("cx", pin.x)
    .attr("cy", pin.y)
    .style("fill", "white")
    .style("stroke", "black")


updateRocks(rocks)


function updateRocks(rocks) {
    svg.selectAll(".rock")
        .data(rocks, d=>d.id)
        .join(
            enter => {
                enter.append("circle")
                    .attr("class", "rock")
                    .attr("name", d => d.name)
                    .attr("id", d => d.id)
                    .attr("r", rockradius)
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y)
                    .style("fill", d => d.color)
                    .style("stroke", "grey")
                    .style("stroke-width", rockoutline)
                    .call(d3.drag()
                        .clickDistance(CLICK_DISTANCE)
                        .on("start", dragstarted)
                        .on("drag", dragged)
                        .on("end", dragended)
                    );
            },
            update => {
                update
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y)
            },
            exit => exit.remove()
        )   
}

function updateMeasures(measures) {
    const t = d3.transition()
        .duration(750);

    svg.selectAll(".measure")
        .data(measures, d => d.id)
        .join(
            enter => {
                enter.append("circle")
                    .attr("class", "measure")
                    .attr("id", d => d.id)
                    .attr("r", d => d.r)
                    .attr("cx", pin.x)
                    .attr("cy", pin.y)
                    .attr("fill", "none")
                    .style("stroke", d => {
                        if (d.color == "red") {
                            return "maroon"
                        } else {
                            return "darkgoldenrod"
                        }
                    })
                    .style("stroke-width", 2);
            },
            update => {
                update.attr("r", d => d.r)
            },
            exit => {
                exit.remove()
            }
        )
}

function clicked(d, i) {
    if (d3.event.defaultPrevented) return; // dragged
}

function dragstarted(d) {
  d.startX = d3.event.sourceEvent.clientX;
  d.startY = d3.event.sourceEvent.clientY;
}

function dragged(d) {
  var e = d3.select(this),
      dStartX = d.startX - d3.event.sourceEvent.clientX,
      dStartY = d.startY - d3.event.sourceEvent.clientY;

  if (dStartX * dStartX + dStartY * dStartY > CLICK_DISTANCE_2 &&
      !e.classed("active")) {

    e.raise().classed("active", true);
  }

  e.attr("cx", d.x = d3.event.x).attr("cy", d.y = d3.event.y);
  if (rockInHouse(d)) {
    r = rockDist(d) - svg_rockradius
    // update radius or add measure circle around rock 
    if (measures.some(m => m.id == d.id)){
        measure = measures.find(m => m.id == d.id)
        measure.r = r
    } else {
        measures.push({id: d.id, r: r, color: d.color})
    }
  } else {
    // remove measure circle
    measures = measures.filter(m => m.id != d.id)
  }
  updateMeasures(measures)
}

function dragended(d) {

  const filter = (e) => e.id == d.id
  let i = rocks.findIndex(filter)
  rocks[i].x = d.x
  rocks[i].y = d.y
  updateRocks(rocks)
  d3.select(this).classed("active", false);
}

var rockDist = (rock) => Math.sqrt((pin.x - rock.x)**2 + (pin.y - rock.y)**2)

var rockInHouse = function(rock) {
    if (rockDist(rock) <= radii.twelve + svg_rockradius) {
        return true
    }
    return false
}

</script>
